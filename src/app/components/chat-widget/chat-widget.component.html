<!-- Floating Chat Button -->
<div class="chat-button" (click)="toggleChat()" [class.open]="isOpen">
  <svg *ngIf="!isOpen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
  </svg>
  <svg *ngIf="isOpen" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </svg>
</div>

<!-- Chat Window -->
<div class="chat-window" [class.open]="isOpen">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <div class="header-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L2 22l5.71-.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2z"></path>
          <circle cx="9" cy="12" r="1"></circle>
          <circle cx="15" cy="12" r="1"></circle>
        </svg>
      </div>
      <div class="header-text">
        <h3>AI Assistant</h3>
        <p>Service Request Analyzer</p>
      </div>
    </div>
  </div>

  <!-- Messages Container -->
  <div class="messages-container" #messageContainer>
    <div *ngFor="let message of messages"
         class="message-wrapper"
         [class.user-message]="message.role === 'user'"
         [class.ai-message]="message.role === 'assistant'">
      <div class="message-bubble">
        <!-- Message Text -->
        <div class="message-text" *ngIf="message.text">{{ message.text }}</div>

        <!-- Message Image -->
        <div class="message-image" *ngIf="message.imageUrl">
          <img [src]="message.imageUrl" [alt]="'Attached image'" />
        </div>

        <!-- Timestamp -->
        <div class="message-time">{{ formatTime(message.timestamp) }}</div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="message-wrapper ai-message">
      <div class="message-bubble loading">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-banner">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Image Preview (when image is selected) -->
  <div *ngIf="imagePreviewUrl" class="image-preview-container">
    <div class="image-preview">
      <img [src]="imagePreviewUrl" alt="Selected image preview" />
      <button type="button" class="remove-image-btn" (click)="removeImage()" title="Remove image">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-container">
    <input
      type="file"
      #fileInput
      accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
      (change)="onFileSelected($event)"
      style="display: none;"
    />

    <button
      type="button"
      class="attach-btn"
      (click)="triggerFileInput()"
      [disabled]="isLoading"
      title="Attach image">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>
    </button>

    <input
      type="text"
      class="message-input"
      [(ngModel)]="userInput"
      (keypress)="onKeyPress($event)"
      [disabled]="isLoading"
      placeholder="Describe the service needed..."
      autocomplete="off"
    />

    <button
      type="button"
      class="send-btn"
      (click)="sendMessage()"
      [disabled]="isLoading || (!userInput.trim() && !selectedImage)"
      title="Send message">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</div>
