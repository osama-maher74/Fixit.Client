<div class="appointment-container">
    <!-- Header -->
    <div class="header">
        <button class="back-button" (click)="goBack()">
            <span>←</span> Back
        </button>
        <h1>{{ (isEditMode ? 'APPOINTMENT_SCHEDULING.TITLE_EDIT' : 'APPOINTMENT_SCHEDULING.TITLE_NEW') | translate }}</h1>
    </div>

    <!-- Craftsman Info -->
    <div class="craftsman-card" *ngIf="craftsman">
        <div class="profile-image">
            <img [src]="craftsman.profileImage || '/assets/default-avatar.png'" [alt]="craftsman.fName">
        </div>
        <div class="craftsman-details">
            <h2>{{ craftsman.fName }} {{ craftsman.lName }}</h2>
            <p class="specialization">{{ craftsman.describtion }}</p>
            <div class="info-row">
                <div class="rating" *ngIf="craftsman.rating">
                    <span class="stars">
                        @for (filled of getStarsArray(Math.round(craftsman.rating)); track filled) {
                        <svg [class.filled]="filled"
                             class="star-icon"
                             viewBox="0 0 24 24"
                             fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                        </svg>
                        }
                    </span>
                    <span class="rating-value">{{ craftsman.rating }}/5.0</span>
                </div>
                <div class="rate">
                    <span class="label">Rate:</span>
                    <span class="value">${{ craftsman.hourlyRate }}/hr</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Week View Calendar -->
    <div class="week-section">
        <h3>Select Date</h3>

        <!-- Loading Week -->
        <div *ngIf="loadingWeek" class="loading-week">
            <div class="spinner"></div>
            <p>Loading available days...</p>
        </div>

        <!-- Week Days Grid -->
        <div *ngIf="!loadingWeek" class="week-grid">
            <button *ngFor="let day of weekDays" class="day-card" [class.selected]="selectedDay === day"
                [class.available]="day.isAvailable" [class.unavailable]="!day.isAvailable" [class.today]="day.isToday"
                (click)="onDaySelected(day)">
                <span class="day-name">{{ day.dayName }}</span>
                <span class="day-date">{{ day.dateString }}</span>
                <span class="availability-badge" *ngIf="day.isAvailable">✓</span>
            </button>
        </div>
    </div>

    <!-- Time Slots -->
    <div class="slots-section" *ngIf="selectedDay">
        <div class="slots-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <h3>Time Slots for {{ selectedDay.fullDayName }}</h3>
        </div>

        <!-- Loading State -->
        <div *ngIf="loadingSlots" class="loading">
            <div class="spinner"></div>
            <p>Loading time slots...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="slotsError && !loadingSlots" class="error-message">
            {{ slotsError }}
        </div>

        <!-- Slots Grid -->
        <div *ngIf="!loadingSlots && !slotsError && availableSlots.length > 0" class="slots-grid">
            <button *ngFor="let slot of availableSlots" class="slot-button" [class.selected]="selectedTimeSlot === slot"
                [class.available]="slot.status === 'Available'" [class.booked]="slot.status === 'Booked'"
                [disabled]="slot.status === 'Booked'" (click)="slot.status === 'Available' && onSlotSelected(slot)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span class="slot-time">{{ slot.time }}</span>
                <span *ngIf="slot.status === 'Booked'" class="booked-label">Booked</span>
            </button>
        </div>
    </div>

    <!-- Craftsman Reviews -->
    <div class="reviews-section" *ngIf="!loadingReviews && reviews.length > 0">
        <div class="reviews-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            <h3>{{ 'APPOINTMENT_SCHEDULING.REVIEWS_TITLE' | translate }}</h3>
            <div class="reviews-stats" *ngIf="averageRating && averageRating.averageRating != null">
                <span class="avg-rating">{{ averageRating.averageRating?.toFixed(1) || '0.0' }}</span>
                <div class="stars">
                    <span *ngFor="let filled of getStarsArray(Math.round(averageRating.averageRating || 0))"
                          class="star" [class.filled]="filled">★</span>
                </div>
                <span class="total-reviews">({{ averageRating.totalReviews || 0 }} {{ 'APPOINTMENT_SCHEDULING.REVIEWS_COUNT' | translate }})</span>
            </div>
        </div>

        <div class="reviews-list">
            <div class="review-card" *ngFor="let review of reviews.slice(0, 3)">
                <div class="review-header">
                    <div class="review-user">
                        <div class="user-avatar">
                            <span>{{ review.clientName ? review.clientName.charAt(0).toUpperCase() : 'C' }}</span>
                        </div>
                        <div class="user-info">
                            <h4>{{ review.clientName || ('APPOINTMENT_SCHEDULING.ANONYMOUS' | translate) }}</h4>
                            <span class="review-date">{{ formatDate(review.reviewDate) }}</span>
                        </div>
                    </div>
                    <div class="review-rating">
                        <span *ngFor="let filled of getStarsArray(review.ratingValue)"
                              class="star" [class.filled]="filled">★</span>
                    </div>
                </div>
                <p class="review-comment">{{ review.comment }}</p>
            </div>

            <div class="no-more-reviews" *ngIf="reviews.length === 0">
                <p>{{ 'APPOINTMENT_SCHEDULING.NO_REVIEWS' | translate }}</p>
            </div>
        </div>
    </div>

    <!-- Loading Reviews -->
    <div class="reviews-section" *ngIf="loadingReviews">
        <div class="reviews-header">
            <h3>{{ 'APPOINTMENT_SCHEDULING.REVIEWS_TITLE' | translate }}</h3>
        </div>
        <div class="loading">
            <div class="spinner"></div>
            <p>{{ 'APPOINTMENT_SCHEDULING.LOADING_REVIEWS' | translate }}</p>
        </div>
    </div>

    <!-- Booking Summary -->
    <div class="booking-summary" *ngIf="selectedTimeSlot">
        <h3>Booking Summary</h3>
        <div class="summary-card">
            <div class="summary-item">
                <span class="summary-label">Craftsman:</span>
                <span class="summary-value">{{ craftsman?.fName }} {{ craftsman?.lName }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Service:</span>
                <span class="summary-value">{{ craftsman?.describtion }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Date:</span>
                <span class="summary-value">{{ selectedDay?.fullDayName }}, {{ selectedDay?.dateString }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Time:</span>
                <span class="summary-value">{{ selectedTimeSlot.time }}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Duration:</span>
                <span class="summary-value">{{ serviceDuration }} minutes</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Rate:</span>
                <span class="summary-value">${{ craftsman?.hourlyRate }}/hr</span>
            </div>
        </div>

        <div class="booking-actions">
            <button class="confirm-button" (click)="confirmBooking()" [disabled]="isBooking">
                <span *ngIf="!isBooking">{{ (isEditMode ? 'APPOINTMENT_SCHEDULING.CONFIRM_NEW_APPOINTMENT' : 'APPOINTMENT_SCHEDULING.CONFIRM_APPOINTMENT') | translate }}</span>
                <span *ngIf="isBooking">{{ (isEditMode ? 'APPOINTMENT_SCHEDULING.UPDATING' : 'APPOINTMENT_SCHEDULING.BOOKING') | translate }}</span>
            </button>
        </div>
    </div>
</div>