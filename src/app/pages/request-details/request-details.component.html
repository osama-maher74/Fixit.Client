<div class="request-details-container">
    <!-- Loading State -->
    @if (loading) {
    <div class="loading-container">
        <div class="spinner"></div>
        <p>{{ 'REQUEST_DETAILS.LOADING' | translate }}</p>
    </div>
    }

    <!-- Error State -->
    @if (error && !loading) {
    <div class="error-container">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-message">{{ error }}</p>
        <button class="btn-back" (click)="goBack()">{{ 'REQUEST_DETAILS.BACK_TO_MY_REQUESTS' | translate }}</button>
    </div>
    }

    <!-- Request Details -->
    @if (!loading && !error && request) {
    <div class="details-wrapper">
        <!-- Back Button -->
        <button class="btn-back-top" (click)="goBack()">
            <span class="back-icon">‚Üê</span>
            {{ 'REQUEST_DETAILS.BACK_TO_MY_REQUESTS' | translate }}
        </button>

        <!-- Details Card -->
        <div class="details-card">
            <!-- Header with Status -->
            <div class="card-header">
                <div class="title-row">
                    <h1 class="request-title">{{ getServiceTranslationKey(request.serviceName) | translate }}</h1>

                    <span class="request-id">#{{ request.servicesRequestId || request.id }}</span>
                </div>
                <div class="status-badge" [ngClass]="getStatusClass(request.status)">
                    <span class="status-icon">{{ getStatusIcon(request.status) }}</span>
                    <span class="status-text">{{ getStatusText(request.status) }}</span>
                </div>
            </div>

            <!-- Request Image -->
            <div class="image-container">
                <img [src]="getImageUrl()" [alt]="request.serviceName || 'Service'" class="request-image" />
            </div>

            <!-- Details Grid -->
            <div class="details-grid">
                <!-- Craftsman Info -->
                @if (request.craftsManName) {
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üë∑</span>
                        <span>{{ 'REQUEST_DETAILS.CRAFTSMAN' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ request.craftsManName }}</div>
                </div>
                }

                <!-- Client Info -->
                @if (request.clientName) {
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üë§</span>
                        <span>{{ 'REQUEST_DETAILS.CLIENT' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ request.clientName }}</div>
                </div>
                }

                <!-- Location -->
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üìç</span>
                        <span>{{ 'REQUEST_DETAILS.LOCATION' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ request.location || ('REQUEST_DETAILS.NOT_SPECIFIED' | translate) }}
                    </div>

                </div>

                <!-- Request Date -->
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üìÖ</span>
                        <span>{{ 'REQUEST_DETAILS.REQUESTED_AT' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ formatDate(request.requestAt) }}</div>
                </div>

                <!-- Service Start Time -->
                @if (request.serviceStartTime) {
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üïê</span>
                        <span>{{ 'REQUEST_DETAILS.SERVICE_START_TIME' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ formatDate(request.serviceStartTime) }}</div>
                </div>
                }

                <!-- Completed At -->
                @if (request.completedAt) {
                <div class="detail-item highlight">
                    <div class="detail-label">
                        <span class="detail-icon">‚úÖ</span>
                        <span>{{ 'REQUEST_DETAILS.COMPLETED_AT' | translate }}</span>
                    </div>
                    <div class="detail-value completed-value">{{ formatDate(request.completedAt) }}</div>
                </div>
                }

                <!-- Suggested Price -->
                @if (request.suggestedPrice) {
                <div class="detail-item">
                    <div class="detail-label">
                        <span class="detail-icon">üíµ</span>
                        <span>{{ 'REQUEST_DETAILS.SUGGESTED_PRICE' | translate }}</span>
                    </div>
                    <div class="detail-value">{{ request.suggestedPrice }} EGP</div>
                </div>
                }

                <!-- Total Amount -->
                @if (request.totalAmount) {
                <div class="detail-item highlight">
                    <div class="detail-label">
                        <span class="detail-icon">üí∞</span>
                        <span>{{ 'REQUEST_DETAILS.TOTAL_AMOUNT' | translate }}</span>
                    </div>
                    <div class="detail-value price-value">{{ request.totalAmount }} EGP</div>
                </div>
                }
            </div>

            <!-- In Progress Notification (Client only) -->
            <!-- @if (isInProgress() && !isCraftsman()) {
            <div class="in-progress-notification">
                <div class="notification-icon">üöÄ</div>
                <div class="notification-content">
                    <h3 class="notification-title">{{ 'REQUEST_DETAILS.SERVICE_IN_PROGRESS' | translate }}</h3>
                    <p class="notification-message">
                        <strong>{{ request.craftsManName }}</strong> {{ 'REQUEST_DETAILS.SERVICE_IN_PROGRESS_MESSAGE' | translate }}
                    </p>
                    <div class="notification-details">
                        <div class="detail-row">
                            <span class="detail-icon">üìç</span>
                            <span class="detail-text">{{ request.location || ('REQUEST_DETAILS.LOCATION_NOT_SPECIFIED' | translate) }}</span>
                        </div>
                        @if (request.serviceStartTime) {
                        <div class="detail-row">
                            <span class="detail-icon">üïê</span>
                            <span class="detail-text">{{ formatDate(request.serviceStartTime) }}</span>
                        </div>
                        }
                    </div>
                </div>
            </div>
            } -->

            <!-- Description Section -->
            <div class="description-section">
                <h2 class="section-title">
                    <span class="section-icon">üìù</span>
                    {{ 'REQUEST_DETAILS.DESCRIPTION' | translate }}
                </h2>
                <p class="description-text">{{ request.description || ('REQUEST_DETAILS.NO_DESCRIPTION' | translate) }}
                </p>
            </div>

            <!-- Complaint Section (Display existing complaints) -->
            @if (existingComplaints && existingComplaints.length > 0) {
            <div class="complaint-section">
                <h2 class="section-title">
                    <span class="section-icon">‚ö†Ô∏è</span>
                    {{ 'REQUEST_DETAILS.MY_COMPLAINTS' | translate }}
                    @if (existingComplaints.length > 1) {
                    <span class="complaint-count">({{ existingComplaints.length }})</span>
                    }
                </h2>
                <div class="complaint-status-card" [class.solved]="existingComplaints[0].status === 'Solved'"
                    [class.pending]="existingComplaints[0].status === 'Pending'">
                    <div class="status-header">
                        <span class="status-badge">
                            @switch (existingComplaints[0].status) {
                            @case ('Pending') { {{ 'ADMIN_COMPLAINTS.STATUS_PENDING' | translate }} }
                            @case ('Resolved') { {{ 'ADMIN_COMPLAINTS.STATUS_RESOLVED' | translate }} }
                            @case ('Solved') { {{ 'ADMIN_COMPLAINTS.STATUS_RESOLVED' | translate }} }
                            @case ('In Progress') { {{ 'ADMIN_COMPLAINTS.STATUS_IN_PROGRESS' | translate }} }
                            @case ('InProgress') { {{ 'ADMIN_COMPLAINTS.STATUS_IN_PROGRESS' | translate }} }
                            @default { {{ existingComplaints[0].status }} }
                            }
                        </span>
                        <span class="complaint-date">{{ formatDateShort(existingComplaints[0].createdAt) }}</span>
                    </div>
                    <p class="complaint-content"><strong>{{ 'REQUEST_DETAILS.COMPLAINT_LABEL' | translate }}:</strong>
                        {{ existingComplaints[0].content }}</p>
                    @if (existingComplaints[0].adminResponse) {
                    <div class="admin-response">
                        <p class="response-label"><strong>{{ 'REQUEST_DETAILS.ADMIN_RESPONSE' | translate }}:</strong>
                        </p>
                        <p class="response-content">{{ existingComplaints[0].adminResponse }}</p>
                        <span class="response-date">{{ formatDateShort(existingComplaints[0].respondedAt) }}</span>
                    </div>
                    }
                </div>
                @if (existingComplaints.length > 1) {
                <button class="btn-view-all-complaints" (click)="viewAllComplaints()">
                    <span class="icon">üìÇ</span>
                    {{ 'REQUEST_DETAILS.VIEW_ALL_COMPLAINTS' | translate }} ({{ existingComplaints.length }})
                </button>
                }
            </div>
            }

            <!-- Review Section (Display existing review) -->
            @if (request.reviewRatingValue || request.reviewComment) {
            <div class="review-section">
                <h2 class="section-title">
                    <span class="section-icon">‚≠ê</span>
                    {{ 'REQUEST_DETAILS.REVIEW' | translate }}
                </h2>
                @if (request.reviewRatingValue) {
                <div class="rating-container">
                    <span class="rating-label">{{ 'REQUEST_DETAILS.RATING' | translate }}:</span>
                    <div class="stars">
                        @for (star of [1, 2, 3, 4, 5]; track star) {
                        <span class="star" [class.filled]="star <= (request.reviewRatingValue || 0)">‚òÖ</span>
                        }
                    </div>
                    <span class="rating-value">({{ request.reviewRatingValue }}/5)</span>
                </div>
                }
                @if (request.reviewComment) {
                <p class="review-comment">{{ request.reviewComment }}</p>
                }
            </div>
            }

            <!-- Review Form Section (Add/Edit Review - Client only, hidden from Admin) -->
            @if (isCompleted() && !isCraftsman() && !isAdmin()) {
            <div class="review-form-section">
                <h2 class="section-title">
                    <span class="section-icon">{{ hasExistingReview() ? '‚úèÔ∏è' : '‚ûï' }}</span>
                    {{ hasExistingReview() ? ('REQUEST_DETAILS.EDIT_REVIEW' | translate) : ('REQUEST_DETAILS.ADD_REVIEW'
                    | translate) }}
                </h2>

                <div class="review-form">
                    <!-- Star Rating Input -->
                    <div class="form-group">
                        <label class="form-label">{{ 'REQUEST_DETAILS.RATING_LABEL' | translate }}</label>
                        <div class="star-rating-input">
                            @for (star of [1, 2, 3, 4, 5]; track star) {
                            <span class="star-input" [class.filled]="star <= reviewRating"
                                (click)="setStarRating(star)">‚òÖ</span>
                            }
                        </div>
                        @if (reviewRating > 0) {
                        <span class="rating-display">{{ reviewRating }} / 5</span>
                        }
                    </div>

                    <!-- Comment Input -->
                    <div class="form-group">
                        <label for="review-comment-input" class="form-label">{{ 'REQUEST_DETAILS.COMMENT' | translate
                            }}</label>
                        <textarea id="review-comment-input" class="form-textarea" [(ngModel)]="reviewComment"
                            [placeholder]="'REQUEST_DETAILS.COMMENT_PLACEHOLDER' | translate" rows="4"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button class="btn-submit-review" (click)="submitReviewForm()" [disabled]="submittingReview">
                        @if (submittingReview) {
                        <span class="spinner-small"></span>
                        <span>{{ hasExistingReview() ? ('REQUEST_DETAILS.UPDATING' | translate) :
                            ('REQUEST_DETAILS.SUBMITTING' | translate) }}</span>
                        } @else {
                        <span>{{ hasExistingReview() ? ('‚úì ' + ('REQUEST_DETAILS.UPDATE_REVIEW' | translate)) : ('‚úì ' +
                            ('REQUEST_DETAILS.SUBMIT_REVIEW' | translate)) }}</span>
                        }
                    </button>
                </div>
            </div>
            }

            <!-- Action Buttons (hidden from Admin and when Cancelled) -->
            @if (!isAdmin() && !isCancelled()) {
            <div class="action-buttons">
                @if (canEditStartTime()) {
                <button class="btn-edit-time" (click)="editStartTime()">
                    <span>üïê {{ 'REQUEST_DETAILS.EDIT_START_TIME' | translate }}</span>
                </button>
                }
                @if (isInProgress() && !isCraftsman()) {
                <button class="btn-complete" (click)="completeRequest()" [disabled]="completingRequest">
                    @if (completingRequest) {
                    <span class="spinner-small"></span>
                    <span>{{ 'REQUEST_DETAILS.COMPLETING' | translate }}</span>
                    } @else {
                    <span>‚úì {{ 'REQUEST_DETAILS.COMPLETE_REQUEST' | translate }}</span>
                    }
                </button>
                }

                 <!-- Craftsman "Any Problems" Button -->
                @if (isCraftsman() && isInProgress()) {
                    <button class="btn-problem" (click)="openManageRequestModal()">
                        <span>‚ö†Ô∏è {{ 'REQUEST_DETAILS.ANY_PROBLEMS' | translate }}</span>
                    </button>
                }

                <!-- Client Problem Button (or specific statuses for anyone else) -->
                @if (!isCraftsman() && (isInProgress() || isCompleted())) {
                <button class="btn-problem" (click)="onProblemClicked()">
                    <span>‚ö†Ô∏è {{ 'REQUEST_DETAILS.HAVING_PROBLEM' | translate }}</span>
                </button>
                }

            </div>
            }
        </div>
    </div>
    }
</div>