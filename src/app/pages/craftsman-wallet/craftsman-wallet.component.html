<div class="wallet-container">
  <!-- LOADING STATE -->
  @if (isLoading()) {
    <div class="loading-wrapper">
      <div class="loading-spinner"></div>
      <p class="loading-text">Loading your wallet...</p>
    </div>
  }

  <!-- ERROR STATE -->
  @else if (errorMessage() && !wallet()) {
    <div class="error-wrapper">
      <div class="error-card">
        <div class="error-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 class="error-title">Failed to Load Wallet</h2>
        <p class="error-message">{{ errorMessage() }}</p>
        <button class="btn btn-retry" (click)="retryLoad()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Try Again
        </button>
      </div>
    </div>
  }

  <!-- WALLET DATA -->
  @else if (wallet()) {
    <!-- Header with Back Button -->
    <div class="wallet-header">
      <button class="back-button" (click)="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        {{ isAdminView() ? ('WALLET.BACK_TO_CRAFTSMAN_DETAILS' | translate) : ('WALLET.BACK_TO_PROFILE' | translate) }}
      </button>
      <h1 class="page-title">{{ isAdminView() ? 'Craftsman Wallet' : 'My Wallet' }}</h1>
    </div>

    <!-- Balance Card -->
    <div class="balance-card">
      <div class="balance-header">
        <div class="balance-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
          </svg>
        </div>
        <div class="balance-content">
          <p class="balance-label">{{ 'WALLET.CURRENT_BALANCE' | translate }}</p>
          <h2 class="balance-amount">{{ wallet()?.balance || 0 | number:'1.2-2' }} EGP</h2>
        </div>
        @if (!isAdminView()) {
        <button class="btn-withdraw" (click)="openWithdrawalModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {{ 'WALLET.WITHDRAW_BUTTON' | translate }}
        </button>
        }
      </div>
      <div class="balance-gradient"></div>
    </div>

    <!-- Transactions Section -->
    <div class="transactions-section">
      <div class="section-header">
        <h2 class="section-title">{{ 'WALLET.TRANSACTION_HISTORY' | translate }}</h2>
        <span class="transaction-count">
          {{ getSortedTransactions().length }}
          {{ getSortedTransactions().length === 1 ? ('WALLET.TRANSACTION' | translate) : ('WALLET.TRANSACTIONS' | translate) }}
        </span>
      </div>

      @if (getSortedTransactions().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
          <p class="empty-text">{{ 'WALLET.NO_TRANSACTIONS' | translate }}</p>
          <p class="empty-subtext">{{ 'WALLET.NO_TRANSACTIONS_SUBTEXT' | translate }}</p>
        </div>
      } @else {
        <div class="transactions-list">
          @for (transaction of getSortedTransactions(); track transaction.id) {
            <div class="transaction-card"
                 [class.transaction-positive]="isAddTransaction(transaction)"
                 [class.transaction-negative]="!isAddTransaction(transaction)">
              <div class="transaction-icon-wrapper">
                <div class="transaction-icon">
                  @if (isAddTransaction(transaction)) {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                  } @else {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                  }
                </div>
              </div>

              <div class="transaction-details">
                <p class="transaction-type">
                  {{ isAddTransaction(transaction) ? ('WALLET.DEPOSIT' | translate) : ('WALLET.WITHDRAW' | translate) }}
                </p>
                <p class="transaction-date">{{ formatDate(transaction.createdAt) }}</p>

                <!-- Admin: Show withdrawal method and account info -->
                @if (isAdminView() && !isAddTransaction(transaction) && transaction.transactiontype !== null && transaction.transactiontype !== undefined) {
                  <div class="withdrawal-info">
                    <span class="withdrawal-method-label">{{ 'WALLET.METHOD_LABEL' | translate }}</span>
                    <span class="withdrawal-method-value">{{ getTransactionTypeText(transaction.transactiontype) }}</span>
                  </div>
                  @if (transaction.transationInfo) {
                    <div class="withdrawal-info">
                      <span class="withdrawal-method-label">{{ getAccountInfoLabel(transaction.transactiontype) }}</span>
                      <span class="withdrawal-method-value">{{ transaction.transationInfo }}</span>
                    </div>
                  }
                }
              </div>

              <div class="transaction-amount">
                <span [class.amount-positive]="isAddTransaction(transaction)"
                      [class.amount-negative]="!isAddTransaction(transaction)">
                  {{ isAddTransaction(transaction) ? '+' : '-' }}{{ transaction.amount | number:'1.2-2' }} EGP
                </span>
                
                <!-- Payment Status Badge (visible for withdrawal transactions) -->
                @if (!isAddTransaction(transaction)) {
                  @if (transaction.isPayed) {
                    <span class="status-badge status-paid">{{ 'WALLET.PAID' | translate }}</span>
                  } @else {
                    <span class="status-badge status-pending">{{ 'WALLET.PENDING_PAYMENT' | translate }}</span>
                  }
                }
              </div>
              
              <!-- Mark as Paid Button (Admin only, for withdrawal transactions) -->
              @if (isAdminView() && !isAddTransaction(transaction)) {
                <button
                  class="btn-mark-paid"
                  [class.btn-mark-pending]="transaction.isPayed"
                  [disabled]="isUpdatingTransaction() === transaction.id"
                  (click)="togglePaymentStatus(transaction)">
                  @if (isUpdatingTransaction() === transaction.id) {
                    <span class="spinner"></span>
                    {{ 'WALLET.UPDATING' | translate }}
                  } @else {
                    {{ transaction.isPayed ? ('WALLET.MARK_PENDING' | translate) : ('WALLET.MARK_AS_PAID' | translate) }}
                  }
                </button>
              }
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Withdrawal Modal -->
  @if (showWithdrawalModal()) {
    <div class="modal-overlay" (click)="closeWithdrawalModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        @if (!withdrawalSuccess()) {
          <!-- Withdrawal Form -->
          <div class="modal-header">
            <h2 class="modal-title">{{ 'WALLET.WITHDRAWAL_FORM.TITLE' | translate }}</h2>
            <button class="modal-close" (click)="closeWithdrawalModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="modal-body">
            <p class="modal-subtitle">{{ 'WALLET.WITHDRAWAL_FORM.SUBTITLE' | translate }}</p>

            <!-- Available Balance -->
            <div class="available-balance">
              <span class="available-label">{{ 'WALLET.WITHDRAWAL_FORM.AVAILABLE_BALANCE' | translate }}:</span>
              <span class="available-amount">{{ wallet()?.balance || 0 | number:'1.2-2' }} EGP</span>
            </div>

            <!-- Withdrawal Amount -->
            <div class="form-group">
              <label class="form-label">{{ 'WALLET.WITHDRAWAL_FORM.AMOUNT' | translate }}</label>
              <div class="input-wrapper">
                <span class="input-prefix">EGP</span>
                <input
                  type="number"
                  class="form-input"
                  [placeholder]="'WALLET.WITHDRAWAL_FORM.AMOUNT_PLACEHOLDER' | translate"
                  [(ngModel)]="withdrawalAmount"
                  min="0"
                  [max]="wallet()?.balance || 0"
                  step="0.01"
                />
              </div>
              @if (withdrawalAmount() && withdrawalAmount()! > (wallet()?.balance || 0)) {
                <p class="error-text">{{ 'WALLET.WITHDRAWAL_FORM.INSUFFICIENT_BALANCE' | translate }}</p>
              }
            </div>

            <!-- Withdrawal Method -->
            <div class="form-group">
              <label class="form-label">{{ 'WALLET.WITHDRAWAL_FORM.METHOD' | translate }}</label>
              <select
                class="form-select"
                [(ngModel)]="selectedTransactionType"
              >
                <option [ngValue]="null">{{ 'WALLET.WITHDRAWAL_FORM.SELECT_METHOD' | translate }}</option>
                <option [ngValue]="TransactionType.Instapay">{{ 'WALLET.WITHDRAWAL_FORM.METHOD_INSTAPAY' | translate }}</option>
                <option [ngValue]="TransactionType.Ewallet">{{ 'WALLET.WITHDRAWAL_FORM.METHOD_EWALLET' | translate }}</option>
                <option [ngValue]="TransactionType.Credit">{{ 'WALLET.WITHDRAWAL_FORM.METHOD_CREDIT' | translate }}</option>
              </select>
            </div>

            <!-- Method-specific Info -->
            @if (selectedTransactionType() !== null) {
              <div class="form-group">
                <label class="form-label">{{ getWithdrawalMethodLabel() }}</label>
                <input
                  type="text"
                  class="form-input"
                  [placeholder]="getWithdrawalMethodPlaceholder()"
                  [(ngModel)]="withdrawalMethodInfo"
                />
              </div>
            }

            <!-- Error Message -->
            @if (withdrawalError()) {
              <div class="alert alert-error">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {{ withdrawalError() }}
              </div>
            }
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" (click)="closeWithdrawalModal()" [disabled]="isWithdrawing()">
              {{ 'WALLET.WITHDRAWAL_FORM.CANCEL' | translate }}
            </button>
            <button
              class="btn btn-primary"
              (click)="submitWithdrawal()"
              [disabled]="!isWithdrawalFormValid() || isWithdrawing()"
            >
              @if (isWithdrawing()) {
                <div class="btn-spinner"></div>
                {{ 'WALLET.WITHDRAWAL_FORM.PROCESSING' | translate }}
              } @else {
                {{ 'WALLET.WITHDRAWAL_FORM.SUBMIT' | translate }}
              }
            </button>
          </div>
        } @else {
          <!-- Success Message -->
          <div class="success-screen">
            <div class="success-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <h2 class="success-title">{{ 'WALLET.WITHDRAWAL_FORM.SUCCESS_TITLE' | translate }}</h2>
            <p class="success-message">{{ 'WALLET.WITHDRAWAL_FORM.SUCCESS_MESSAGE' | translate }}</p>
            <button class="btn btn-primary" (click)="closeWithdrawalModal()">
              {{ 'WALLET.WITHDRAWAL_FORM.CLOSE' | translate }}
            </button>
          </div>
        }
      </div>
    </div>
  }
</div>
